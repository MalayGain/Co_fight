{"ast":null,"code":"import _toConsumableArray from \"@babel/runtime/helpers/esm/toConsumableArray\";\nimport _slicedToArray from \"@babel/runtime/helpers/esm/slicedToArray\";\nimport _classCallCheck from \"@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/esm/createClass\";\nimport { createMat4 } from './math-utils';\nimport { zoomToScale, pixelsToWorld, lngLatToWorld, worldToLngLat, worldToPixels, getProjectionMatrix, getDistanceScales, getViewMatrix } from './web-mercator-utils';\nimport _fitBounds from './fit-bounds';\nimport getBounds from './get-bounds';\nimport * as mat4 from 'gl-matrix/mat4';\nimport * as vec2 from 'gl-matrix/vec2';\n\nvar WebMercatorViewport = function () {\n  function WebMercatorViewport() {\n    var _ref = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {\n      width: 1,\n      height: 1\n    },\n        width = _ref.width,\n        height = _ref.height,\n        _ref$latitude = _ref.latitude,\n        latitude = _ref$latitude === void 0 ? 0 : _ref$latitude,\n        _ref$longitude = _ref.longitude,\n        longitude = _ref$longitude === void 0 ? 0 : _ref$longitude,\n        _ref$zoom = _ref.zoom,\n        zoom = _ref$zoom === void 0 ? 0 : _ref$zoom,\n        _ref$pitch = _ref.pitch,\n        pitch = _ref$pitch === void 0 ? 0 : _ref$pitch,\n        _ref$bearing = _ref.bearing,\n        bearing = _ref$bearing === void 0 ? 0 : _ref$bearing,\n        _ref$altitude = _ref.altitude,\n        altitude = _ref$altitude === void 0 ? 1.5 : _ref$altitude,\n        _ref$nearZMultiplier = _ref.nearZMultiplier,\n        nearZMultiplier = _ref$nearZMultiplier === void 0 ? 0.02 : _ref$nearZMultiplier,\n        _ref$farZMultiplier = _ref.farZMultiplier,\n        farZMultiplier = _ref$farZMultiplier === void 0 ? 1.01 : _ref$farZMultiplier;\n\n    _classCallCheck(this, WebMercatorViewport);\n\n    width = width || 1;\n    height = height || 1;\n    var scale = zoomToScale(zoom);\n    altitude = Math.max(0.75, altitude);\n    var center = lngLatToWorld([longitude, latitude]);\n    center[2] = 0;\n    this.projectionMatrix = getProjectionMatrix({\n      width: width,\n      height: height,\n      pitch: pitch,\n      altitude: altitude,\n      nearZMultiplier: nearZMultiplier,\n      farZMultiplier: farZMultiplier\n    });\n    this.viewMatrix = getViewMatrix({\n      height: height,\n      scale: scale,\n      center: center,\n      pitch: pitch,\n      bearing: bearing,\n      altitude: altitude\n    });\n    this.width = width;\n    this.height = height;\n    this.scale = scale;\n    this.latitude = latitude;\n    this.longitude = longitude;\n    this.zoom = zoom;\n    this.pitch = pitch;\n    this.bearing = bearing;\n    this.altitude = altitude;\n    this.center = center;\n    this.distanceScales = getDistanceScales(this);\n\n    this._initMatrices();\n\n    this.equals = this.equals.bind(this);\n    this.project = this.project.bind(this);\n    this.unproject = this.unproject.bind(this);\n    this.projectPosition = this.projectPosition.bind(this);\n    this.unprojectPosition = this.unprojectPosition.bind(this);\n    Object.freeze(this);\n  }\n\n  _createClass(WebMercatorViewport, [{\n    key: \"_initMatrices\",\n    value: function _initMatrices() {\n      var width = this.width,\n          height = this.height,\n          projectionMatrix = this.projectionMatrix,\n          viewMatrix = this.viewMatrix;\n      var vpm = createMat4();\n      mat4.multiply(vpm, vpm, projectionMatrix);\n      mat4.multiply(vpm, vpm, viewMatrix);\n      this.viewProjectionMatrix = vpm;\n      var m = createMat4();\n      mat4.scale(m, m, [width / 2, -height / 2, 1]);\n      mat4.translate(m, m, [1, -1, 0]);\n      mat4.multiply(m, m, vpm);\n      var mInverse = mat4.invert(createMat4(), m);\n\n      if (!mInverse) {\n        throw new Error('Pixel project matrix not invertible');\n      }\n\n      this.pixelProjectionMatrix = m;\n      this.pixelUnprojectionMatrix = mInverse;\n    }\n  }, {\n    key: \"equals\",\n    value: function equals(viewport) {\n      if (!(viewport instanceof WebMercatorViewport)) {\n        return false;\n      }\n\n      return viewport.width === this.width && viewport.height === this.height && mat4.equals(viewport.projectionMatrix, this.projectionMatrix) && mat4.equals(viewport.viewMatrix, this.viewMatrix);\n    }\n  }, {\n    key: \"project\",\n    value: function project(xyz) {\n      var _ref2 = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {},\n          _ref2$topLeft = _ref2.topLeft,\n          topLeft = _ref2$topLeft === void 0 ? true : _ref2$topLeft;\n\n      var worldPosition = this.projectPosition(xyz);\n      var coord = worldToPixels(worldPosition, this.pixelProjectionMatrix);\n\n      var _coord = _slicedToArray(coord, 2),\n          x = _coord[0],\n          y = _coord[1];\n\n      var y2 = topLeft ? y : this.height - y;\n      return xyz.length === 2 ? [x, y2] : [x, y2, coord[2]];\n    }\n  }, {\n    key: \"unproject\",\n    value: function unproject(xyz) {\n      var _ref3 = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {},\n          _ref3$topLeft = _ref3.topLeft,\n          topLeft = _ref3$topLeft === void 0 ? true : _ref3$topLeft,\n          _ref3$targetZ = _ref3.targetZ,\n          targetZ = _ref3$targetZ === void 0 ? undefined : _ref3$targetZ;\n\n      var _xyz = _slicedToArray(xyz, 3),\n          x = _xyz[0],\n          y = _xyz[1],\n          z = _xyz[2];\n\n      var y2 = topLeft ? y : this.height - y;\n      var targetZWorld = targetZ && targetZ * this.distanceScales.unitsPerMeter[2];\n      var coord = pixelsToWorld([x, y2, z], this.pixelUnprojectionMatrix, targetZWorld);\n\n      var _this$unprojectPositi = this.unprojectPosition(coord),\n          _this$unprojectPositi2 = _slicedToArray(_this$unprojectPositi, 3),\n          X = _this$unprojectPositi2[0],\n          Y = _this$unprojectPositi2[1],\n          Z = _this$unprojectPositi2[2];\n\n      if (Number.isFinite(z)) {\n        return [X, Y, Z];\n      }\n\n      return Number.isFinite(targetZ) ? [X, Y, targetZ] : [X, Y];\n    }\n  }, {\n    key: \"projectPosition\",\n    value: function projectPosition(xyz) {\n      var _lngLatToWorld = lngLatToWorld(xyz),\n          _lngLatToWorld2 = _slicedToArray(_lngLatToWorld, 2),\n          X = _lngLatToWorld2[0],\n          Y = _lngLatToWorld2[1];\n\n      var Z = (xyz[2] || 0) * this.distanceScales.unitsPerMeter[2];\n      return [X, Y, Z];\n    }\n  }, {\n    key: \"unprojectPosition\",\n    value: function unprojectPosition(xyz) {\n      var _worldToLngLat = worldToLngLat(xyz),\n          _worldToLngLat2 = _slicedToArray(_worldToLngLat, 2),\n          X = _worldToLngLat2[0],\n          Y = _worldToLngLat2[1];\n\n      var Z = (xyz[2] || 0) * this.distanceScales.metersPerUnit[2];\n      return [X, Y, Z];\n    }\n  }, {\n    key: \"projectFlat\",\n    value: function projectFlat(lngLat) {\n      return lngLatToWorld(lngLat);\n    }\n  }, {\n    key: \"unprojectFlat\",\n    value: function unprojectFlat(xy) {\n      return worldToLngLat(xy);\n    }\n  }, {\n    key: \"getMapCenterByLngLatPosition\",\n    value: function getMapCenterByLngLatPosition(_ref4) {\n      var lngLat = _ref4.lngLat,\n          pos = _ref4.pos;\n      var fromLocation = pixelsToWorld(pos, this.pixelUnprojectionMatrix);\n      var toLocation = lngLatToWorld(lngLat);\n      var translate = vec2.add([], toLocation, vec2.negate([], fromLocation));\n      var newCenter = vec2.add([], this.center, translate);\n      return worldToLngLat(newCenter);\n    }\n  }, {\n    key: \"getLocationAtPoint\",\n    value: function getLocationAtPoint(_ref5) {\n      var lngLat = _ref5.lngLat,\n          pos = _ref5.pos;\n      return this.getMapCenterByLngLatPosition({\n        lngLat: lngLat,\n        pos: pos\n      });\n    }\n  }, {\n    key: \"fitBounds\",\n    value: function fitBounds(bounds) {\n      var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n      var width = this.width,\n          height = this.height;\n\n      var _fitBounds2 = _fitBounds(Object.assign({\n        width: width,\n        height: height,\n        bounds: bounds\n      }, options)),\n          longitude = _fitBounds2.longitude,\n          latitude = _fitBounds2.latitude,\n          zoom = _fitBounds2.zoom;\n\n      return new WebMercatorViewport({\n        width: width,\n        height: height,\n        longitude: longitude,\n        latitude: latitude,\n        zoom: zoom\n      });\n    }\n  }, {\n    key: \"getBounds\",\n    value: function getBounds(options) {\n      var corners = this.getBoundingRegion(options);\n      var west = Math.min.apply(Math, _toConsumableArray(corners.map(function (p) {\n        return p[0];\n      })));\n      var east = Math.max.apply(Math, _toConsumableArray(corners.map(function (p) {\n        return p[0];\n      })));\n      var south = Math.min.apply(Math, _toConsumableArray(corners.map(function (p) {\n        return p[1];\n      })));\n      var north = Math.max.apply(Math, _toConsumableArray(corners.map(function (p) {\n        return p[1];\n      })));\n      return [[west, south], [east, north]];\n    }\n  }, {\n    key: \"getBoundingRegion\",\n    value: function getBoundingRegion() {\n      var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n      return getBounds(this, options.z || 0);\n    }\n  }]);\n\n  return WebMercatorViewport;\n}();\n\nexport { WebMercatorViewport as default };","map":{"version":3,"sources":["../../src/web-mercator-viewport.js"],"names":["WebMercatorViewport","width","height","latitude","longitude","zoom","pitch","bearing","altitude","nearZMultiplier","farZMultiplier","scale","zoomToScale","Math","center","lngLatToWorld","getProjectionMatrix","getViewMatrix","getDistanceScales","Object","projectionMatrix","viewMatrix","vpm","createMat4","mat4","m","mInverse","viewport","xyz","topLeft","worldPosition","coord","worldToPixels","x","y","y2","targetZ","undefined","z","targetZWorld","pixelsToWorld","X","Y","Z","Number","worldToLngLat","lngLat","xy","pos","fromLocation","toLocation","translate","vec2","newCenter","bounds","options","fitBounds","corners","west","p","east","south","north","getBounds"],"mappings":"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","sourcesContent":["// View and Projection Matrix calculations for mapbox-js style map view properties\nimport {createMat4} from './math-utils';\n\nimport {\n  zoomToScale,\n  pixelsToWorld,\n  lngLatToWorld,\n  worldToLngLat,\n  worldToPixels,\n  getProjectionMatrix,\n  getDistanceScales,\n  getViewMatrix\n} from './web-mercator-utils';\nimport fitBounds from './fit-bounds';\nimport getBounds from './get-bounds';\n\nimport * as mat4 from 'gl-matrix/mat4';\nimport * as vec2 from 'gl-matrix/vec2';\n\nexport default class WebMercatorViewport {\n  // eslint-disable-next-line max-statements\n  constructor(\n    {\n      // Map state\n      width,\n      height,\n      latitude = 0,\n      longitude = 0,\n      zoom = 0,\n      pitch = 0,\n      bearing = 0,\n      altitude = 1.5,\n      nearZMultiplier = 0.02,\n      farZMultiplier = 1.01\n    } = {width: 1, height: 1}\n  ) {\n    // Silently allow apps to send in 0,0 to facilitate isomorphic render etc\n    width = width || 1;\n    height = height || 1;\n\n    const scale = zoomToScale(zoom);\n    // Altitude - prevent division by 0\n    // TODO - just throw an Error instead?\n    altitude = Math.max(0.75, altitude);\n\n    const center = lngLatToWorld([longitude, latitude]);\n    center[2] = 0;\n\n    this.projectionMatrix = getProjectionMatrix({\n      width,\n      height,\n      pitch,\n      altitude,\n      nearZMultiplier,\n      farZMultiplier\n    });\n\n    this.viewMatrix = getViewMatrix({\n      height,\n      scale,\n      center,\n      pitch,\n      bearing,\n      altitude\n    });\n\n    // Save parameters\n    this.width = width;\n    this.height = height;\n    this.scale = scale;\n\n    this.latitude = latitude;\n    this.longitude = longitude;\n    this.zoom = zoom;\n    this.pitch = pitch;\n    this.bearing = bearing;\n    this.altitude = altitude;\n    this.center = center;\n\n    this.distanceScales = getDistanceScales(this);\n\n    this._initMatrices();\n\n    // Bind methods for easy access\n    this.equals = this.equals.bind(this);\n    this.project = this.project.bind(this);\n    this.unproject = this.unproject.bind(this);\n    this.projectPosition = this.projectPosition.bind(this);\n    this.unprojectPosition = this.unprojectPosition.bind(this);\n\n    Object.freeze(this);\n  }\n\n  _initMatrices() {\n    const {width, height, projectionMatrix, viewMatrix} = this;\n\n    // Note: As usual, matrix operations should be applied in \"reverse\" order\n    // since vectors will be multiplied in from the right during transformation\n    const vpm = createMat4();\n    mat4.multiply(vpm, vpm, projectionMatrix);\n    mat4.multiply(vpm, vpm, viewMatrix);\n    this.viewProjectionMatrix = vpm;\n\n    // Calculate matrices and scales needed for projection\n    /**\n     * Builds matrices that converts preprojected lngLats to screen pixels\n     * and vice versa.\n     * Note: Currently returns bottom-left coordinates!\n     * Note: Starts with the GL projection matrix and adds steps to the\n     *       scale and translate that matrix onto the window.\n     * Note: WebGL controls clip space to screen projection with gl.viewport\n     *       and does not need this step.\n     */\n    const m = createMat4();\n\n    // matrix for conversion from location to screen coordinates\n    mat4.scale(m, m, [width / 2, -height / 2, 1]);\n    mat4.translate(m, m, [1, -1, 0]);\n    mat4.multiply(m, m, vpm);\n\n    const mInverse = mat4.invert(createMat4(), m);\n    if (!mInverse) {\n      throw new Error('Pixel project matrix not invertible');\n    }\n\n    this.pixelProjectionMatrix = m;\n    this.pixelUnprojectionMatrix = mInverse;\n  }\n\n  // Two viewports are equal if width and height are identical, and if\n  // their view and projection matrices are (approximately) equal.\n  equals(viewport) {\n    if (!(viewport instanceof WebMercatorViewport)) {\n      return false;\n    }\n\n    return (\n      viewport.width === this.width &&\n      viewport.height === this.height &&\n      mat4.equals(viewport.projectionMatrix, this.projectionMatrix) &&\n      mat4.equals(viewport.viewMatrix, this.viewMatrix)\n    );\n  }\n\n  // Projects xyz (possibly latitude and longitude) to pixel coordinates in window\n  // using viewport projection parameters\n  project(xyz, {topLeft = true} = {}) {\n    const worldPosition = this.projectPosition(xyz);\n    const coord = worldToPixels(worldPosition, this.pixelProjectionMatrix);\n\n    const [x, y] = coord;\n    const y2 = topLeft ? y : this.height - y;\n    return xyz.length === 2 ? [x, y2] : [x, y2, coord[2]];\n  }\n\n  // Unproject pixel coordinates on screen onto world coordinates,\n  // (possibly [lon, lat]) on map.\n  unproject(xyz, {topLeft = true, targetZ = undefined} = {}) {\n    const [x, y, z] = xyz;\n\n    const y2 = topLeft ? y : this.height - y;\n    const targetZWorld = targetZ && targetZ * this.distanceScales.unitsPerMeter[2];\n    const coord = pixelsToWorld([x, y2, z], this.pixelUnprojectionMatrix, targetZWorld);\n    const [X, Y, Z] = this.unprojectPosition(coord);\n\n    if (Number.isFinite(z)) {\n      return [X, Y, Z];\n    }\n    return Number.isFinite(targetZ) ? [X, Y, targetZ] : [X, Y];\n  }\n\n  // NON_LINEAR PROJECTION HOOKS\n  // Used for web meractor projection\n\n  projectPosition(xyz) {\n    const [X, Y] = lngLatToWorld(xyz);\n    const Z = (xyz[2] || 0) * this.distanceScales.unitsPerMeter[2];\n    return [X, Y, Z];\n  }\n\n  unprojectPosition(xyz) {\n    const [X, Y] = worldToLngLat(xyz);\n    const Z = (xyz[2] || 0) * this.distanceScales.metersPerUnit[2];\n    return [X, Y, Z];\n  }\n\n  // Project [lng,lat] on sphere onto [x,y] on 512*512 Mercator Zoom 0 tile.\n  projectFlat(lngLat) {\n    return lngLatToWorld(lngLat);\n  }\n\n  // Unproject world point [x,y] on map onto {lat, lon} on sphere\n  unprojectFlat(xy) {\n    return worldToLngLat(xy);\n  }\n\n  // Get the map center that place a given [lng, lat] coordinate at screen point [x, y]\n  getMapCenterByLngLatPosition({lngLat, pos}) {\n    const fromLocation = pixelsToWorld(pos, this.pixelUnprojectionMatrix);\n    const toLocation = lngLatToWorld(lngLat);\n\n    const translate = vec2.add([], toLocation, vec2.negate([], fromLocation));\n    const newCenter = vec2.add([], this.center, translate);\n\n    return worldToLngLat(newCenter);\n  }\n\n  // Legacy method name\n  getLocationAtPoint({lngLat, pos}) {\n    return this.getMapCenterByLngLatPosition({lngLat, pos});\n  }\n\n  // Returns a new viewport that fit around the given rectangle.\n  fitBounds(bounds, options = {}) {\n    const {width, height} = this;\n    const {longitude, latitude, zoom} = fitBounds(Object.assign({width, height, bounds}, options));\n    return new WebMercatorViewport({width, height, longitude, latitude, zoom});\n  }\n\n  getBounds(options) {\n    const corners = this.getBoundingRegion(options);\n\n    const west = Math.min(...corners.map(p => p[0]));\n    const east = Math.max(...corners.map(p => p[0]));\n    const south = Math.min(...corners.map(p => p[1]));\n    const north = Math.max(...corners.map(p => p[1]));\n    return [[west, south], [east, north]];\n  }\n\n  getBoundingRegion(options = {}) {\n    return getBounds(this, options.z || 0);\n  }\n}\n"]},"metadata":{},"sourceType":"module"}